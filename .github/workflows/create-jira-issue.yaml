name: Create Jira Issue for Security Alerts

on:
  repository_vulnerability_alert:
      types: [create, reopen]

permissions:
  contents: read
  security-events: read

jobs:
  create_jira_issue:
    runs-on: ubuntu-latest

    steps:
      - name: Extract alert data
        id: extract
        run: |
          echo "PACKAGE_NAME=$(jq -r '.alert.dependency.package.name' $GITHUB_EVENT_PATH)" >> $GITHUB_ENV
          echo "SEVERITY=$(jq -r '.alert.severity' $GITHUB_EVENT_PATH)" >> $GITHUB_ENV
          
          # Advisory link (fallback to empty if none)
          ADVISORY_URL=$(jq -r '.alert.advisory.references[0].url // ""' $GITHUB_EVENT_PATH)
          echo "ADVISORY_URL=$ADVISORY_URL" >> $GITHUB_ENV

      - name: Create Jira Issue JSON
        run: |
          cat <<EOF > issue.json
          {
            "fields": {
              "project": { "key": "SEC" },
              "summary": "Vulnerability in ${PACKAGE_NAME} (${SEVERITY})",
              "description": "A new vulnerability was detected in **${PACKAGE_NAME}**.\n\nSeverity: ${SEVERITY}\n\nAdvisory: ${ADVISORY_URL}",
              "issuetype": { "name": "Bug" },
              "labels": ["security", "github-alert"]
            }
          }
          EOF

      - name: Create Jira Issue
        env:
          JIRA_URL: ${{ secrets.JIRA_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        run: |
          curl -X POST \
            -H "Content-Type: application/json" \
            -u "$JIRA_USER_EMAIL:$JIRA_API_TOKEN" \
            --data @issue.json \
            "$JIRA_URL/rest/api/3/issue"
